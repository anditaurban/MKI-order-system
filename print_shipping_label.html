<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Label Pengiriman Per Koli - MKI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @media print {
      @page {
        size: calc(var(--label-width, 150mm)) calc(var(--label-height, 100mm)) landscape;
        margin: 0;
      }

      body {
        margin: 0;
      }
    }

    .ellipsis-3 {
      display: -webkit-box;
      display: box;               /* fallback */
      
      -webkit-line-clamp: 3;
      line-clamp: 3;              /* standard property */

      -webkit-box-orient: vertical;
      box-orient: vertical;       /* fallback */

      overflow: hidden;
      text-overflow: ellipsis;
    }

    .page-break {
      page-break-after: always;
    }
  </style>
</head>

<body class="bg-white font-sans text-[12px] leading-tight">

  <div id="combinedLabels" class="px-0 py-4">
  </div>

  <script>
    // --- CONFIG ---
    const script = document.createElement('script');
    script.src = `./assets/js/api.js?v=${new Date().getTime()}`;
    script.onload = () => loadAllLabels();
    document.body.appendChild(script);

    const defaultWidth = '150';
    const defaultHeight = '100';

    const labelWidth = localStorage.getItem('label_width') || defaultWidth;
    const labelHeight = localStorage.getItem('label_height') || defaultHeight;

    const container = document.getElementById('combinedLabels');
    const urlParams = new URLSearchParams(window.location.search);
    const shipmentIds = urlParams.get('ids')?.split(',') || [];

    // --- MAIN FUNCTION ---
    async function loadAllLabels() {
      container.innerHTML = '';

      for (const id of shipmentIds) {
        try {
          // 1. FETCH SHIPMENT
          const resShipment = await fetch(`${baseUrl}/detail/sales_shipment/${id}`, {
            headers: { 'Authorization': `Bearer ${API_TOKEN}` }
          });
          const dataShipment = await resShipment.json();
          const detailShipment = dataShipment.detail;

          if (!detailShipment) continue;

          let itemsData = [];

          // 2. FETCH PACKAGE (Fallback ke detail items paket)
          if (detailShipment.package_id) {
            try {
              const resPackage = await fetch(`${baseUrl}/detail/sales_package/${detailShipment.package_id}`, {
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
              });
              const dataPackage = await resPackage.json();
              itemsData = dataPackage.detail?.items || [];
            } catch (err) {
              console.warn("Gagal ambil detail paket", err);
            }
          } else {
            itemsData = detailShipment.items || [];
          }

          // 3. Grouping Item
          const koliGroups = groupItemsByKoli(itemsData);
          const koliNames = Object.keys(koliGroups).sort((a, b) => {
            return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
          });
          const totalKoli = koliNames.length;

          if (totalKoli === 0) {
            const defaultItems = detailShipment.item_list ? detailShipment.item_list.join(', ') : "Item data tidak tersedia";
            createLabelHTML(detailShipment, "Standard", 1, 1, defaultItems);
            continue;
          }

          // 4. Generate Label Loop
          koliNames.forEach((koliName, index) => {
            const itemsInThisKoli = koliGroups[koliName].join(', ');
            const packageNumber = index + 1;
            createLabelHTML(detailShipment, koliName, packageNumber, totalKoli, itemsInThisKoli);
          });

        } catch (error) {
          console.error('Gagal memuat shipment ID:', id, error);
        }
      }

      generateBarcodes();
    }

    // --- Helper: Grouping Item ---
    function groupItemsByKoli(items) {
      const groups = {};
      if (!Array.isArray(items) || items.length === 0) return groups;

      const addItem = (groupName, itemName, qty) => {
        let key = (groupName && groupName.trim() !== "") ? groupName.toLowerCase() : "-";
        if (!groups[key]) groups[key] = [];
        groups[key].push(`${itemName} (${qty})`);
      };

      items.forEach(item => {
        if (item.bundling === true && Array.isArray(item.item_detail) && item.item_detail.length > 0) {
          item.item_detail.forEach(sub => {
            addItem(sub.package_group, sub.item_name, sub.qty);
          });
        } else {
          addItem(item.package_group, item.item_name, item.qty);
        }
      });

      return groups;
    }

    // --- Helper: HTML Label ---
    function createLabelHTML(detail, koliName, currentPkg, totalPkg, itemsList) {
      const labelDiv = document.createElement('div');
      labelDiv.className = 'mx-auto border border-black overflow-hidden relative page-break text-[12px] pt-[6mm] px-4 mb-10';
      labelDiv.style.width = labelWidth + 'mm';
      labelDiv.style.height = labelHeight + 'mm';

      const displayKoliName = koliName.toUpperCase();

      labelDiv.innerHTML = `
          <div class="relative h-15 w-full">
            <img src="assets/img/cropped-Logo-MKI.webp" alt="Logo" class="absolute top-0 left-[5mm] h-7 mb-2">

            <div class="text-center pl-10 pr-10">
              <p class="text-[12px] font-bold">FAKTUR ${detail.no_inv}</p>
              <svg class="barcode-invoice w-full h-12" data-value="${detail.no_inv}"></svg>
            </div>

            <div class="absolute top-0 right-[5mm] flex flex-col items-end text-right">
              <img src="${detail.courier_logo}" alt="Logo Kurir" class="h-7 mb-1">
            </div>
          </div>

          <div class="border-t border-black pt-1 flex gap-4 text-[12px] leading-tight mb-2">
            <div class="w-1/2">
              <strong>Pengirim:</strong><br>
              ${detail.sender_name}<br>
              ${detail.sender_address}<br>
              <span class="font-semibold">${detail.sender_phone}</span>
            </div>
            <div class="w-1/2">
              <strong>Penerima:</strong><br>
              ${detail.nama}<br>
              ${detail.shipment_address}<br>
              ${detail.region_name}<br>
              <span class="font-semibold">${detail.whatsapp}</span>
            </div>
          </div>

          <div class="text-[11px] h-auto min-h-[40px] mb-1 overflow-hidden border-t border-dashed border-gray-400 pt-1 ellipsis-3">
    <strong>ISI PAKET:</strong><br>
    ${itemsList}
</div>


          <div class="text-[12px] font-bold mb-2 border-b border-black pb-1">
             ðŸ“¦ ${displayKoliName}
          </div>

          <div class="border border-black py-1 text-center text-[12px] mb-2 absolute bottom-2 w-[calc(100%-2rem)]">
            <a class="font-semibold">CATATAN PENGIRIMAN</a>
            <br><a>${detail.courier_note || '-'}</a>
          </div>
        `;

      container.appendChild(labelDiv);
    }

    function generateBarcodes() {
      document.querySelectorAll('.barcode-invoice').forEach(svg => {
        JsBarcode(svg, svg.dataset.value, { format: "CODE128", width: 1.5, height: 40, displayValue: false });
      });
    }

    function printLabel() {
      setTimeout(() => {
        if (window !== window.parent) {
          html2pdf()
            .set({
              margin: 0,
              filename: `shipping-labels-combined.pdf`,
              image: { type: 'jpeg', quality: 1 },
              html2canvas: { scale: 2 },
              jsPDF: {
                unit: 'mm',
                format: [parseFloat(labelWidth), parseFloat(labelHeight)],
                orientation: 'landscape'
              }
            })
            .from(container)
            .save()
            .then(() => { window.parent.postMessage({ type: 'PDF_DONE' }, '*'); });
        } else {
          window.print();
        }
      }, 500);
    }
  </script>
</body>

</html>